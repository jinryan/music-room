(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=e(a);fetch(a.href,o)}})();const d={tempo:120,key:"A",scale:["A","B","C","D","E","F","G"],chordProgression:[{root:"A",notes:["A2","C3","E3"],name:"Am"},{root:"F",notes:["F2","A2","C3"],name:"F"},{root:"C",notes:["C3","E3","G3"],name:"C"},{root:"G",notes:["G2","B2","D3"],name:"G"}],barsPerChord:2,beatsPerBar:4,totalBars:8,totalBeats:32};class B{progression;barsPerChord;currentChordIndex=0;barCounter=0;constructor(t,e){this.progression=t,this.barsPerChord=e}getCurrentChord(){return this.progression[this.currentChordIndex]}advance(){this.barCounter++,this.barCounter>=this.barsPerChord&&(this.barCounter=0,this.currentChordIndex=(this.currentChordIndex+1)%this.progression.length)}getChordTones(t=3){return this.getCurrentChord().notes.map(s=>s.replace(/[0-9]/g,"")+t)}getChordForBar(t){const e=t<0?this.progression.length*this.barsPerChord+t%(this.progression.length*this.barsPerChord):t,s=Math.floor(e/this.barsPerChord)%this.progression.length;return this.progression[s]}getChordTonesForBar(t,e=3){return this.getChordForBar(t).notes.map(a=>a.replace(/[0-9]/g,"")+e)}reset(){this.currentChordIndex=0,this.barCounter=0}}function b(i){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],e=i.match(/^([A-G]#?)(\d+)$/);if(!e)throw new Error(`Invalid note format: ${i}`);const[,s,a]=e,o=parseInt(a,10),n=t.indexOf(s);if(n===-1)throw new Error(`Invalid note name: ${s}`);const r=(o+1)*12+n;return 440*Math.pow(2,(r-69)/12)}let v=!1;function A(i){v=i}function h(i,t,...e){v&&console.log(`[${i}] ${t}`,...e)}function T(i,t,...e){v&&console.warn(`[${i}] ${t}`,...e)}function S(i,t){const e=t.currentTime;try{i.gain.gain.cancelScheduledValues(e),i.gain.gain.setValueAtTime(0,e),i.gain.gain.cancelScheduledValues(e+100),i.gain.gain.setValueAtTime(0,e+.1),i.gain.gain.setValueAtTime(0,e+1)}catch{}try{i.gain.disconnect()}catch{}if(i.filter)try{i.filter.disconnect()}catch{}try{i.source.disconnect()}catch{}try{i.source.stop(e)}catch{}}function P(i,t,e,s){const{attack:a,decay:o,sustain:n,release:r,volume:c}=s,l=t+a,u=l+o,f=t+e-r;i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(c,l),i.gain.linearRampToValueAtTime(c*n,u),i.gain.setValueAtTime(c*n,f),i.gain.linearRampToValueAtTime(0,t+e)}class x{context;tempo;activeNodes=new Set;moduleName;constructor(t,e,s){this.context=t,this.tempo=e,this.moduleName=s}addActiveNode(t){this.activeNodes.add(t)}getBeatDuration(){return 60/this.tempo}stop(){h(this.moduleName,`STOP called - stopping ${this.activeNodes.size} active nodes`);let t=0;for(const e of this.activeNodes)try{S(e,this.context),t++}catch(s){T(this.moduleName,"Error stopping node:",s)}h(this.moduleName,`STOP complete - stopped ${t} nodes, disconnected all gains`),this.activeNodes.clear()}}class M extends x{chordManager;scheduledNotes=new Set;constructor(t,e,s){super(t,s,"BassLayer"),this.chordManager=e}createBassSynth(){const t=this.context.createOscillator();t.type="sawtooth";const e=this.context.createBiquadFilter();e.type="lowpass",e.frequency.value=200,e.Q.value=2;const s=this.context.createGain();return s.gain.value=0,t.connect(e),e.connect(s),{source:t,gain:s,filter:e}}scheduleNote(t,e){if(this.scheduledNotes.has(t))return;this.scheduledNotes.add(t);const s=Math.floor(t/4),o=this.chordManager.getChordForBar(s).root+"2",n=b(o),r=this.context.currentTime,c=e-r;h(this.moduleName,`Scheduling note: ${o} (${n.toFixed(1)}Hz) at beat ${t}, in ${c.toFixed(3)}s`);const l=this.createBassSynth();l.gain.connect(this.context.destination),this.addActiveNode(l);const f=this.getBeatDuration()*2,N=l.source;N.frequency.value=n,l.source.start(e),l.source.stop(e+f),P(l.gain,e,f,{attack:.01,decay:.2,sustain:.3,release:.5,volume:.4})}schedulePattern(t,e){const s=this.getBeatDuration(),a=[0,2,8,10,16,18,24,26];for(let o=0;o<e;o++)for(const n of a){const r=o*32+n,c=t+r*s;this.scheduleNote(r,c)}}start(t){this.scheduledNotes.clear(),this.schedulePattern(t,4)}}class G extends x{scheduledKicks=new Set;scheduledSnares=new Set;scheduledHiHats=new Set;constructor(t,e){super(t,e,"DrumLayer")}createKick(){const t=this.context.createOscillator();t.type="sine";const e=this.context.createGain();return e.gain.value=0,t.connect(e),{source:t,gain:e}}createSnare(){const t=this.context.sampleRate*.1,e=this.context.createBuffer(1,t,this.context.sampleRate),s=e.getChannelData(0);for(let n=0;n<t;n++)s[n]=Math.random()*2-1;const a=this.context.createBufferSource();a.buffer=e;const o=this.context.createGain();return o.gain.value=0,a.connect(o),{source:a,gain:o}}createHiHat(){const t=this.context.createOscillator();t.type="square",t.frequency.value=800;const e=this.context.createGain();return e.gain.value=0,t.connect(e),{source:t,gain:e}}scheduleDrum(t,e,s){const a=t==="kick"?this.scheduledKicks:t==="snare"?this.scheduledSnares:this.scheduledHiHats;if(a.has(e))return;a.add(e);const o=t==="kick"?this.createKick():t==="snare"?this.createSnare():this.createHiHat();o.gain.connect(this.context.destination),this.addActiveNode(o);const n=this.context.currentTime,r=s-n;h(this.moduleName,`Scheduling ${t} at beat ${e}, in ${r.toFixed(3)}s`);const c=t==="kick"?{duration:.2,volume:.6}:t==="snare"?{duration:.15,volume:.4}:{duration:.05,volume:.2};if(t==="kick"){const l=o.source;l.frequency.setValueAtTime(60,s),l.frequency.exponentialRampToValueAtTime(30,s+.1)}o.source.start(s),o.source.stop(s+c.duration),o.gain.gain.setValueAtTime(0,s),o.gain.gain.linearRampToValueAtTime(c.volume,s+.001),t==="kick"?o.gain.gain.exponentialRampToValueAtTime(.01,s+.1):t==="snare"?o.gain.gain.exponentialRampToValueAtTime(.01,s+.05):o.gain.gain.exponentialRampToValueAtTime(.01,s+.02),o.gain.gain.linearRampToValueAtTime(0,s+c.duration)}scheduleKick(t,e){this.scheduleDrum("kick",t,e)}scheduleSnare(t,e){this.scheduleDrum("snare",t,e)}scheduleHiHat(t,e){this.scheduleDrum("hihat",t,e)}schedulePattern(t,e){const s=this.getBeatDuration();for(let a=0;a<e;a++){const o=a*32;for(let n=0;n<8;n++){const r=o+n*4;this.scheduleKick(r,t+r*s),this.scheduleKick(r+2,t+(r+2)*s)}for(let n=0;n<8;n++){const r=o+n*4;this.scheduleSnare(r+1,t+(r+1)*s),this.scheduleSnare(r+3,t+(r+3)*s)}for(let n=0;n<32;n++)for(let r=0;r<2;r++){const c=n+r*.5,l=o+c;this.scheduleHiHat(Math.floor(l*2),t+l*s)}}}start(t){this.scheduledKicks.clear(),this.scheduledSnares.clear(),this.scheduledHiHats.clear(),this.schedulePattern(t,4)}}class D{oscillator;gain;filter;isActive=!1;constructor(t,e){this.oscillator=t.createOscillator(),this.oscillator.type="sine",this.oscillator.frequency.value=e,this.filter=t.createBiquadFilter(),this.filter.type="lowpass",this.filter.frequency.value=2e3,this.filter.Q.value=1,this.gain=t.createGain(),this.gain.gain.value=0,this.oscillator.connect(this.filter),this.filter.connect(this.gain)}connect(t){this.gain.connect(t)}start(t,e){if(this.isActive)return;this.isActive=!0;const s=.8,a=2,o=.7,n=.15;this.oscillator.start(t),this.oscillator.stop(t+e),this.gain.gain.setValueAtTime(0,t),this.gain.gain.linearRampToValueAtTime(n,t+s),this.gain.gain.setValueAtTime(n*o,t+s),this.gain.gain.setValueAtTime(n*o,t+e-a),this.gain.gain.linearRampToValueAtTime(0,t+e)}stop(t){if(!this.isActive)return;const e={source:this.oscillator,gain:this.gain,filter:this.filter};S(e,t),this.isActive=!1}}class w{context;chordManager;tempo;voices=new Map;lfo=null;lfoGain=null;scheduledChords=new Set;lfoStarted=!1;constructor(t,e,s){this.context=t,this.chordManager=e,this.tempo=s,this.setupReverb(),this.setupLFO()}setupReverb(){const t=this.context.createDelay(.1);t.delayTime.value=.05;const e=this.context.createGain();e.gain.value=.3;const s=this.context.createGain();s.gain.value=.5,t.connect(e),e.connect(t),t.connect(s),s.connect(this.context.destination)}setupLFO(){this.lfo=this.context.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=.5,this.lfoGain=this.context.createGain(),this.lfoGain.gain.value=300,this.lfo.connect(this.lfoGain)}createVoice(t){const e=b(t);return new D(this.context,e)}scheduleChord(t,e){if(this.scheduledChords.has(t))return;this.scheduledChords.add(t);const s=this.chordManager.getChordForBar(t),a=this.context.currentTime,o=e-a;h("PadLayer",`Scheduling chord: ${s.name} (${s.notes.join(", ")}) at bar ${t}, in ${o.toFixed(3)}s`);const r=60/this.tempo*8;for(const c of this.voices.values())c.stop(this.context);this.voices.clear();for(const c of s.notes){const l=this.createVoice(c);l.connect(this.context.destination),l.start(e,r),this.voices.set(c,l)}}schedulePattern(t,e){const s=60/this.tempo,a=[0,8,16,24];for(let o=0;o<e;o++)for(const n of a){const r=o*32+n,c=Math.floor(r/4),l=t+r*s;this.scheduleChord(c,l)}}start(t){this.scheduledChords.clear(),this.lfo&&!this.lfoStarted&&(this.lfo.start(),this.lfoStarted=!0),this.schedulePattern(t,4)}stop(){if(h("PadLayer",`STOP called - stopping ${this.voices.size} voices, clearing ${this.scheduledChords.size} scheduled chords`),this.scheduledChords.clear(),this.lfo&&this.lfoStarted){try{this.lfo.stop()}catch{}this.lfoStarted=!1,this.setupLFO()}let t=0;for(const e of this.voices.values())e.stop(this.context),t++;h("PadLayer",`STOP complete - stopped ${t} voices`),this.voices.clear()}}class k extends x{chordManager;lastNote=null;restProbability=.4;delay;delayGain;feedbackGain;scheduledNotes=new Set;constructor(t,e,s){super(t,s,"GenerativeMelody"),this.chordManager=e,this.setupDelay()}setupDelay(){const e=this.getBeatDuration()*.5;this.delay=this.context.createDelay(1),this.delay.delayTime.value=e,this.feedbackGain=this.context.createGain(),this.feedbackGain.gain.value=.3,this.delayGain=this.context.createGain(),this.delayGain.gain.value=.4,this.delay.connect(this.feedbackGain),this.feedbackGain.connect(this.delay),this.delay.connect(this.delayGain),this.delayGain.connect(this.context.destination)}getNextNote(t){if(Math.random()<this.restProbability)return null;const e=this.chordManager.getChordTonesForBar(t,4);if(!this.lastNote)return e[Math.floor(Math.random()*e.length)];if(Math.random()<.7){const s=e.indexOf(this.lastNote);if(s!==-1){const a=[e[s],e[(s+1)%e.length],e[(s-1+e.length)%e.length]];return a[Math.floor(Math.random()*a.length)]}}return e[Math.floor(Math.random()*e.length)]}createMelodySynth(t){const e=this.context.createOscillator();e.type="triangle",e.frequency.value=t;const s=this.context.createGain();return s.gain.value=0,e.connect(s),s.connect(this.context.destination),s.connect(this.delay),{source:e,gain:s}}scheduleNote(t,e){if(this.scheduledNotes.has(t))return;this.scheduledNotes.add(t);const s=Math.floor(t/8),a=this.getNextNote(s);if(!a)return;const o=this.context.currentTime,n=e-o;h(this.moduleName,`Scheduling note: ${a} at eighth note ${t}, in ${n.toFixed(3)}s`);const r=b(a),c=this.createMelodySynth(r);this.addActiveNode(c);const u=this.getBeatDuration()*.5;c.source.start(e),c.source.stop(e+u);const f=Math.min(.15,u*.6);P(c.gain,e,u,{attack:.01,decay:.05,sustain:.5,release:f,volume:.3}),this.lastNote=a}schedulePattern(t,e){const s=this.getBeatDuration(),a=64;for(let o=0;o<e;o++)for(let n=0;n<a;n++){const r=o*a+n,c=n/2,l=o*32+c,u=t+l*s;this.scheduleNote(r,u)}}start(t){this.scheduledNotes.clear(),this.lastNote=null,this.schedulePattern(t,4)}stop(){h(this.moduleName,`STOP called - stopping ${this.activeNodes.size} active nodes, clearing ${this.scheduledNotes.size} scheduled notes`),this.scheduledNotes.clear(),this.lastNote=null,super.stop()}setRestProbability(t){this.restProbability=Math.max(0,Math.min(1,t))}}class ${context=null;chordManager;bassLayer=null;drumLayer=null;padLayer=null;melodyLayer=null;isPlaying=!1;isStarting=!1;barInterval=null;startTime=0;barCounter=0;constructor(){this.chordManager=new B(d.chordProgression,d.barsPerChord)}ensureContext(){return this.context||(this.context=new AudioContext),this.context}async start(){if(!(this.isPlaying||this.isStarting)){this.isStarting=!0;try{this.isPlaying=!1,this.barInterval!==null&&(clearInterval(this.barInterval),this.barInterval=null),this.stopLayers();const t=this.ensureContext();t.state==="suspended"&&await t.resume(),this.bassLayer=new M(t,this.chordManager,d.tempo),this.drumLayer=new G(t,d.tempo),this.padLayer=new w(t,this.chordManager,d.tempo),this.melodyLayer=new k(t,this.chordManager,d.tempo),this.chordManager.reset(),this.barCounter=0,this.startTime=t.currentTime+.1,this.bassLayer.start(this.startTime),this.drumLayer.start(this.startTime),this.padLayer.start(this.startTime),this.melodyLayer.start(this.startTime);const s=60/d.tempo*d.beatsPerBar*1e3;this.barInterval=(globalThis.setInterval||setInterval)(()=>{if(!(!this.isPlaying||!this.context)&&(this.barCounter++,this.chordManager.advance(),this.barCounter%8===0)){const o=this.context.currentTime+.1;this.bassLayer&&this.bassLayer.start(o),this.drumLayer&&this.drumLayer.start(o),this.padLayer&&this.padLayer.start(o),this.melodyLayer&&this.melodyLayer.start(o)}},s),this.isPlaying=!0}finally{this.isStarting=!1}}}async stop(){h("AutonomousEngine",`STOP called - isPlaying: ${this.isPlaying}`),this.isPlaying=!1,this.barInterval!==null&&(clearInterval(this.barInterval),this.barInterval=null,h("AutonomousEngine","Cleared bar interval")),this.stopLayers(),this.chordManager.reset(),this.barCounter=0,h("AutonomousEngine","STOP complete")}stopLayers(){this.bassLayer&&(this.bassLayer.stop(),this.bassLayer=null),this.drumLayer&&(this.drumLayer.stop(),this.drumLayer=null),this.padLayer&&(this.padLayer.stop(),this.padLayer=null),this.melodyLayer&&(this.melodyLayer.stop(),this.melodyLayer=null)}setEnergy(t){if(this.melodyLayer){const e=.6-t*.4;this.melodyLayer.setRestProbability(e)}}getIsPlaying(){return this.isPlaying}}A(!0);const E=document.querySelector("#app");if(!E)throw new Error("Missing #app root element");const y=new $,C=document.getElementById("startBtn"),L=document.getElementById("stopBtn"),m=document.getElementById("status");if(!C||!L||!m)throw new Error("Missing required UI elements");let g=!1;function p(){const i=y.getIsPlaying();C.disabled=i||g,L.disabled=!i,m.textContent=g?"Starting...":i?"Playing":"Stopped"}C.addEventListener("click",async()=>{if(!(g||y.getIsPlaying())){g=!0,p(),m.textContent="Starting...";try{await y.start()}catch(i){console.error("Failed to start engine",i),m.textContent="Error starting"}finally{g=!1,p()}}});L.addEventListener("click",()=>{if(y.getIsPlaying())try{y.stop()}catch(i){console.error("Failed to stop engine",i),m.textContent="Error stopping"}finally{p()}});p();
